---
title: ë…¸ë“œ í•™ìŠµ 18ì¼ì°¨
date: 2025-01-10
categories:
  - ê³µë¶€ì¼ê¸°
  - Node.js
tags:
  - Node
  - javascript
---
ì•ˆë…•í•˜ì„¸ìš” ğŸ¸

ì´ë²ˆì—” passport ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•´ë´¤ìŠµë‹ˆë‹¤.  
í–ˆê°ˆë¦¬ëŠ” ë¶€ë¶„ì´ ë§ì•„ì„œ ë‚˜ì¤‘ì— ë‹¤ì‹œ ë´ë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì •ë¦¬í•˜ëŠ” ê²ƒì´ ì–´ë µë„¤ìš”  
íŠ¹íˆë‚˜ ìë°”ë¥¼ í˜„ì—…ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì €ëŠ” í•¨ìˆ˜ ë‚´ì— return ì—†ì´ ë¯¸ë“¤ì›¨ì–´ ë‚´ì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ í˜¸ì¶œë¶€ë¡œ ê°’ì„ ì „ë‹¬í•´ì£¼ëŠ” ê²ƒ ê°™ì€ ë¶€ë¶„ì´ ì´í•´ê°€ ì•ˆë˜ì–´ì„œ ë§ì´ í˜¼ë™ì´ ì™”ìŠµë‹ˆë‹¤.  
## passport
### passportë€?
- ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ ë•ëŠ” ë¯¸ë“¤ì›¨ì–´
- ì„¸ì…˜, ì¿ í‚¤ ì²˜ë¦¬ ë“±ì˜ ë³µì¡í•œ ì‘ì—…ë“¤ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
- ì„œë¹„ìŠ¤ ìì²´ì˜ ë¡œê·¸ì¸ ë°©ë²• ì™¸ì—ë„ ì¹´ì¹´ì˜¤, êµ¬ê¸€ ë¡œê·¸ì¸ ë“±ê³¼ ê°™ì€ ë¡œê·¸ì¸ ë°©ë²•ë„ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©° ì´ëŸ¬í•œ ë°©ë²•ì„ êµ¬ë¶„í•˜ëŠ” ê²ƒì„ **ì „ëµ(Strategy)** ì´ë¼ ë¶€ë¦„
### passport ë¡œê·¸ì¸ ì²˜ë¦¬ ìˆœì„œ
ê¸°ë³¸ ì ì¸ ì‚¬ìš© ë°©ë²•ì„ ì•Œê¸°ì— ì•ì„œ passport ì—ì„œ ë¡œê·¸ì¸ ì²˜ë¦¬ì˜ íë¦„ì— ëŒ€í•´ ì´í•´í•˜ê³  ë„˜ì–´ê°ˆ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.  
ì´ ë¶€ë¶„ì„ ì´í•´í•˜ì§€ ëª»í•˜ê³  ë¬´ì‘ì • ì½”ë“œë§Œ ë”°ë¼ ì“°ë‹¤ë³´ë‹ˆê¹Œ ì´í•´ê°€ ì•ˆë˜ëŠ” ë¶€ë¶„ì´ ë§ì•˜ìŠµë‹ˆë‹¤.  

1. ë¡œê·¸ì¸ ìš”ì²­
2. ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸
	- `req.isAuthenticate()` í•¨ìˆ˜ë¥¼ í†µí•´ í™•ì¸
3. ë¡œê·¸ì¸ ì „ëµì— ë”°ë¥¸ ë¯¸ë“¤ì›¨ì–´ í˜¸ì¶œ
	- ì‚¬ì „ì— ì´ˆê¸°í™”í•œ ë¡œì§ì— ë”°ë¼ ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€ íŒë‹¨
4. ê²°ê³¼ì— ë”°ë¼ ë¡œê·¸ì¸ ì„±ê³µ/ì‹¤íŒ¨ íŒë‹¨
	1. ì„±ê³µì‹œ `req.serialize()` ë¥¼ í†µí•´ ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥
5. (ì„±ê³µ ì‹œ) passport ë¯¸ë“¤ì›¨ì–´ëŠ” ì„¸ì…˜ ì¿ í‚¤ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬
	1. `passport.session()` ì—ì„œ ì²˜ë¦¬

### passport ì‚¬ìš© ë°©ë²•
passportë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì§ì ‘ passport ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.  
ì •í™•í•œ í‘œí˜„ì€ ì•„ë‹ˆì§€ë§Œ passport ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìš°ë¦¬ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œë‹¤ ìƒê°í•˜ë©´ ì´í•´ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.  
êµ¬í˜„í•œ passport ëª¨ë“ˆê³¼ passport ë¯¸ë“¤ì›¨ì–´ëŠ” app.jsì—ì„œ ê°ê° ì—°ê²°í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.  
passport ë¯¸ë“¤ì›¨ì–´ ë°›ì•„ë†“ê³ ì„œ ë‘ ê°œë¥¼ ì—°ê²°í•˜ëŠ” ë¶€ë¶„ì´ ì´í•´ê°€ ì•ˆê°€ì„œ ì²˜ìŒì—ëŠ” í•´ë©”ì´ê¸° ì‰½ìŠµë‹ˆë‹¤.  
ì•ì„œ ë°°ì› ë˜ ë¯¸ë“¤ì›¨ì–´ë“¤ì€ 1 ë¯¸ë“¤ì›¨ì–´ 1 ì—°ê²°ì´ì—ˆëŠ”ë° passportëŠ” ëª¨ë“ˆì„ êµ¬í˜„í•˜ê³  ì´ë¥¼ ë˜ app.jsì—ì„œ ë”°ë¡œ ì—°ê²°í•´ì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì— íŠ¹íˆë‚˜ìš”.

ì•„ë˜ëŠ” passport ëª¨ë“ˆì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ íŒŒì¼ êµ¬ì¡°ì˜ ì˜ˆì‹œ ì…ë‹ˆë‹¤.  

```markdown
passport/
â”œâ”€â”€ index.js
â”œâ”€â”€ localStrategy.js
â””â”€â”€ kakaoStrategy.js
```

ê°ê°ì˜ íŒŒì¼ ì„¤ëª…ì…ë‹ˆë‹¤.  
- index.js
	- passportë¥¼ ì´ˆê¸°í™” í•˜ê³  ë‚´ë¶€ì—ì„œëŠ” ì•„ë˜ì˜ ê¸°ëŠ¥ì„ êµ¬í˜„í™” í•©ë‹ˆë‹¤
		- passport.serializeUser()
		- passport.deserializeUser()
		- ì „ëµì— ë§ëŠ” passport ëª¨ë“ˆì˜ Strategy
- localStrategy.js
	- passport-local ì„ ì´ˆê¸°í™” í•˜ê³  LocalStrategy ê°ì²´ë¥¼ ìƒì„±í•˜ê³  passport ê°€ í•´ë‹¹ ê°ì²´ë¥¼ use() í•©ë‹ˆë‹¤. 
	- ë¡œê·¸ì¸ ë¡œì§ì— ë”°ë¥¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ íŒë‹¨ í•˜ê³  ì´ë¥¼ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
- kakaoStrategy.js
	- passport-kakao ë¥¼ ì´ˆê¸°í™”í•˜ê³  KakaoStrategy ê°ì²´ë¥¼ ìƒì„±í•˜ê³  passport ê°€ í•´ë‹¹ ê°ì²´ë¥¼ use() í•©ë‹ˆë‹¤.
	- ë¡œê·¸ì¸ ë¡œì§ì— ë”°ë¥¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ íŒë‹¨ í•˜ê³  ì´ë¥¼ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.

ë‹¤ìŒì€ `app.js` ì—ì„œ passportë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.  

```javascript
const express = require('express');
const app = express();
const session = require('express-session');
const passport = require('passport');
const passportConfig = require('./passport'); // passport ë””ë ‰í† ë¦¬ ë‚´ì˜ index.js

// passport ëª¨ë“ˆ ì´ˆê¸°í™”
passportConfig(); // passport/index.jsì—ì„œ module.exports í•œ ë¶€ë¶„ì„ í˜¸ì¶œ

/* 
passport ë¯¸ë“¤ì›¨ì–´ì˜ initialize(), session()ì€
ì„¸ì…˜ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— express-sessionì„ ë¨¼ì € use() í•œ ë‹¤ìŒì— ì—°ê²°
*/
app.use(session({
	// ìƒëµ...
}));

// req.user, req.login, req.logout req.isAuthticate í•¨ìˆ˜ ìƒì„±
app.use(passport.initialize());

// connect.sid ì´ë¦„ìœ¼ë¡œ ì„¸ì…˜ ì¿ í‚¤ë¥¼ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬
app.use(passport.session());

```

### passport êµ¬í˜„

ì•„ë˜ ì½”ë“œëŠ” passport ë¥¼ êµ¬í˜„í•œ `index.js` ì˜ ì˜ˆì‹œ ì…ë‹ˆë‹¤.  
- `passport.serializeUser`
- `passport.deserializeUser`
ë¥¼ êµ¬í˜„í™”í•˜ê³  ê° ì „ëµë³„ passport ë¥¼ êµ¬í˜„í•œ ê²ƒì„ í˜¸ì¶œí•˜ì—¬ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.  

```javascript
const passport = require('passport');
const local = require('./localStrategy');
const kakao = require('./kakaoStrategy');
const User = require('../models/user');

module.exports = () => {
    passport.serializeUser((user, done)=>{ // req.login í•  ë•Œ í˜¸ì¶œ
        // console.log('user : ',user);
        done(null,user);
    })

    passport.deserializeUser((user, done)=>{ // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ëª¨ë“  í˜¸ì¶œì—ì„œ ì‚¬ìš©
        // console.log('id :',user.user.id);
        User.findOne({where:{id:user.user.id}})
        .then((user)=>{
            done(null,user)
        })
        .catch((err)=>{
            done(err);
        })
    })

    local();

    kakao();
}
```

## passport-local
ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•  ë¡œê·¸ì¸ ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.  
passport-localì˜ Strategy í´ë˜ìŠ¤ ê°ì²´ë¥¼ êµ¬í˜„í•˜ê³  ì´ë¥¼ passport ì—ì„œ use() í•˜ë„ë¡ ì²˜ë¦¬í•©ë‹ˆë‹¤.  
ì˜ˆì œ ì½”ë“œ) 

```javascript
const passport = require('passport');
const User = require('../models/user');
// const LocalStrategy = require('passport-local').Strategy;
const {Strategy : LocalStrategy} = require('passport-local'); // ìœ„ ë¼ì¸ì˜ ë°©ë²•ê³¼ ê²°ê³¼ëŠ” ë™ì¼í•˜ë©° êµ¬ì¡°ë¶„í•´í• ë‹¹ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
const bcrypt = require('bcrypt');

module.exports = () => {
    passport.use(new LocalStrategy({
        usernameField : 'email', // req.body.email ì„ ìœ ì € ì•„ì´ë””ë¡œ ë°›ìŒ
        passwordField : 'password', // req.body.password ë¥¼ ìœ ì € ë¹„ë°€ë²ˆí˜¸ë¡œ ë°›ìŒ
        passReqToCallback : false, // true ì„¤ì •ì‹œ VerifyFunction ì˜ ì²«ë²ˆì§¸ ì¸ìë¡œ ìš”ì²­ ê°ì²´(request) ê°€ ì¶”ê°€ë¨ ex) async(req,email,password,done)
        session : true // ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥í•´ì„œ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í• ì§€ ì—¬ë¶€. ê¸°ë³¸ê°’ì€ true. *interfaceì—ì„œëŠ” undefined ë¼ê³  í•˜ì§€ë§Œ 
    },async(email, password, done)=>{ // (ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, done) ë¥¼ ê³ ì •ì ìœ¼ë¡œ ë°›ìŒ. *interface í™•ì¸
        try {
            const exUser = await User.findOne({where:{email}});
            if(exUser){
                const result = await bcrypt.compare(password,exUser.password);
                if(result){
                    done(null,{user:exUser}); 
                } else {
                    done(null, false, {message:'ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜'})
                }
            } else {
                connect(null, false, {message:'ë¯¸ê°€ì… íšŒì›'})
            }
        } catch (error) {
            console.error(error);
            done(error);
        }
    }));
}
```
## passport-kakao
passport-kakaoì˜ Strategy í´ë˜ìŠ¤ ê°ì²´ë¥¼ êµ¬í˜„í•˜ê³  passport ì—ì„œ use í•©ë‹ˆë‹¤.  

ì˜ˆì œ ì½”ë“œ)

```javascript
const passport = require('passport');
const { Strategy : KakaoStrategy } = require('passport-kakao');
const User = require('../models/user');

module.exports = () =>{
    passport.use(new KakaoStrategy({
        clientID: process.env.KAKAO_ID,
        callbackURL: process.env.KAKAO_CALLBACK,
        // kakao developers > ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ì œí’ˆ ì„¤ì • > ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ > ë³´ì•ˆ ì—ì„œ ìƒì„±&í™•ì¸ ê°€ëŠ¥
        // clientSecret: '', 
        
        // ê³µì‹ ë¬¸ì„œë¥¼ ì°¾ì•„ë´¤ì§€ë§Œ ì•„ì§ ë‚´ìš© í™•ì¸ ë¶ˆê°€
        // GPT : OAuth ìš”ì²­ URLì— ê¶Œí•œ ëª©ë¡ì˜ êµ¬ë¶„ìë¥¼ ì§€ì •í•˜ëŠ” ì˜µì…˜
        // scopeSeparator: '', 
        
        // ê³µì‹ ë¬¸ì„œë¥¼ ì°¾ì•„ë´¤ì§€ë§Œ ì•„ì§ ë‚´ìš© í™•ì¸ ë¶ˆê°€
        // GPT : ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ì„¤ì •. ì¸í„°í˜ì´ìŠ¤ì—ì„œëŠ” stringì´ë¼ê³  ë˜ì–´ìˆì§€ë§Œ Map ê°ì²´ë¥¼ ë°›ìŒ
        // customHeaders: ''
    },async (accessToken,refreshToken,profile,done)=>{
        // console.log('profile :',profile);
        try {
            const exUser = await User.findOne({where:{snsId : profile.id, provider:'kakao'}});
            if(exUser){
                done(null,{user:exUser, accessToken});
            } else {
                const newUser = await User.create({
                    email : profile._json.kakao_account?.email,
                    nick : profile.displayName, 
                    provider : 'kakao',
                    snsId : profile.id
                });
                done(null,{user:newUser, accessToken});
            }
        } catch (error) {
            console.error(error);
            done(error);
        }
    }));
}
```

---
Q. passport ì´ˆê¸°í™” í•˜ëŠ” ë¶€ë¶„ì„ express-session ë³´ë‹¤ ì•ì„œ ì´ˆê¸°í™” í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ì •ìƒ ë™ì‘ í•˜ëŠ” ê²ƒì€ ì™œì¼ê¹Œ?
A. ì´ë²¤íŠ¸ë¦¬ìŠ¤ë„ˆì™€ ìœ ì‚¬í•˜ë‹¤ê³  ìƒê°í•˜ë©´ ì´í•´ê°€ ì‰¬ì› ë‹¤. ë¡œê·¸ì¸ì— ëŒ€í•œ ì „ëµì„ ì„¤ì •í•˜ê³  ì´ˆê¸°í™”ë§Œ í–ˆì„ ë¿ ì‹¤ì œ ë™ì‘ì€ ìš”ì²­ì´ ì˜¬ ë•Œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì½”ë“œ ì‘ì„± ë‹¹ì‹œì—ëŠ” express-sessionì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸

Q. passport ì „ëµì— ì‚¬ìš©ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´ëŠ” ì „ë¶€ Strategy í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ”ë° ì´ëŠ” ì–´ë””ì„œ ì˜¤ëŠ” ê²ƒì¼ê¹Œ?
A. passport ì „ëµì€ ì „ë¶€ passportì—ì„œ ì„ ì–¸ëœ Stategy í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ìœ¼ë©° ì´ë¥¼ êµ¬í˜„í•˜ë„ë¡ ë˜ì–´ ìˆê¸° ë•Œë¬¸